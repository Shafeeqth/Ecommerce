<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>KartFy Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/imgs/theme/favicon.svg" />
    <!-- Template CSS -->
    <link href="/assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
</head>

<body>
    <%- include('../partials/sidenav.ejs') -%><!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="utf-8" />
        <title>Nest Dashboard</title>
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />
        <!-- Favicon -->
        <link
          rel="shortcut icon"
          type="image/x-icon"
          href="/assets/imgs/theme/favicon.svg"
        />
        <!-- Template CSS -->
        <link href="/assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
      </head>
    
      <body>
        <%- include('../partials/sidenav.ejs') -%>
        <main class="main-wrap">
          <!-- Modal -->
          <div
          
            class="modal fade"
            id="exampleModal"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">
                    Create Banner
                  </h1>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form  action="/api/v1/admin/banners/create-banner" method="post" enctype="multipart/form-data">
                    <label for="form-label">Name</label>
                    <input
                      type="text"
                      name="name"
                      placeholder="Enter coupon name"
                      class="form-control my-2"
                    />
                    <label for="form-label">Description</label>
                    <input
                      type="text"
                      name="description"
                      placeholder="Enter Description here"
                      class="form-control my-2"
                    />
                    <label for="form-label">URL Link</label>
                    <input
                      type="text"
                      name="url"
                      placeholder="Example: shop?brand=levis"
                      class="form-control my-2"
                    />
    
                    <label for="form-label">Image</label>
                    <div class="">
                       
                        <img class="img-lg" src="" id="imagePreview" alt="Product image" style="margin-left:50%;" />

                        <input type="file" accept="image/jpeg,image/png" placeholder="Add image" name="image"
                          class="form-control" id="image" data-id="" onchange="previewImage(event)" />
                    </div>
    
                    
    
                    
    
                    
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Submit
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
    
          <!-- edit banner modal -->
          <div
            class="modal fade"
            id="exampleModal2"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">
                    Edit coupon
                  </h1>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form action="/api/v1/admin/banners/edit-banner" method="post" enctype="multipart/form-data">
                    <input style="visibility: hidden;" type="text" name="id" id="bannerId">
                    <label for="form-label">Name</label>
                    <input
                      type="text"
                      name="name"
                      id="name"
                      placeholder="Enter coupon name"
                      class="form-control my-2"
                    />
                    <label for="form-label">Description</label>
                    <input
                      type="text"
                      name="description"
                      id="description"
                      placeholder="Enter Description here"
                      class="form-control my-2"
                    />
                    <label for="form-label">URL Link</label>
                    <input
                      type="text"
                      id="url"
                      name="url"
                      placeholder="Example: shop?brand=levis"
                      class="form-control my-2"
                    />
    
                    <label for="form-label">Image</label>
                    <div class="mb-4 col-lg-3 me-2">
                        <img class="img-lg" src="" id="imagePreview1" alt="Product image" style="
                         
                          margin-bottom: 1.5rem;
                        " />

                        <input type="file" accept="image/jpeg" placeholder="Add image" name="image"
                          class="form-control" id="image1" data-id="" onchange="previewImage1(event)" />
                    </div>
    
                    
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                      >
                        Close
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Submit
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <section class="content-main">
            <div class="content-header">
              <h2 class="content-title">Manage Banner</h2>
              <div>
                <button
                  href="#"
                  class="btn btn-dark"
                  data-bs-toggle="modal"
                  data-bs-target="#exampleModal"
                >
                  <i class="material-icons md-plus"></i> Create Banner
                </button>
              </div>
            </div>
            <div class="card mb-4">
              <!-- card-header end// -->
              <div class="card-body">
                <div class="table-responsive" id="Reload">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Banner Image</th>
                        <th>Title</th>
                        <th>Description</th>
    
                        <th>URL</th>
                        <th> Created date</th>
                        
                        <th class="text-end">Action</th>
                      </tr>
                    </thead>
                    <tbody >
                      <% if(Array.isArray(banners) && banners.length> 0) {%> <%
                        banners.map((c)=> {%>
                      <tr>
                       
                            <td class="col-3 ">
                                <a href="#" class="itemside">
                                    <div class=" text-center">

                                        <img src="/Data/banners/sharped/<%= c.image%>"
                                            class="img-lg  " alt="Userpic" />

                                    </div>
                                    <!-- <div class="info pl-3">
                                        <h6 class="mb-0 title" style="text-transform: capitalize;"></h6>
                                        <small class="text-muted">Seller ID: #439</small>
                                    </div> -->
                                </a>
                            </td>
                            <td>
                            <div class="info pl-3">
                              <h6
                                class="mb-0 title"
                                style="text-transform: capitalize"
                              >
                                <%= c.title %>
                              </h6>
                            
                            </div>
                          </a>
                        </td>
                        <td><%= c.description%></td>
                        <td><%= c.url%></td>
                        
                        <% const formattedDate =
                        c.createdAt?.toLocaleString('en-US', { weekday: 'short',
                        month: 'short', day: 'numeric', year: 'numeric',  }); %>
                        <td><%= formattedDate%></td>
                        
                       
    
                        <td class="text-end">
                          <button
                            id="button"
                            class="btn btn-sm btn-dark rounded font-sm mt-15"
                            data-user-id=""
                            data-status=""
                            onclick="listOrUnlist('<%= c._id%>')"
                          >
                            <%= c.isListed ? "List" : "Unlist" %>
                          </button>
                          <button
                            id="button"
                            class="btn btn-sm btn-dark rounded font-sm mt-15"
                            data-user-id=""
                            onclick="return editCoupon('<%= c._id%>', '<%=c.title%>', '<%=c.description%>', '<%=c.url%>',  '<%=c.image%>')"
                            data-status=""
                            data-bs-toggle="modal"
                            data-bs-target="#exampleModal2"
                          >
                            Edit
                          </button>
                        </td>
                      </tr>
    
                      <% }) %> <% }else{ %>
                      <tr>
                        <td colspan="6">No banner found</td>
                      </tr>
                      <% } %>
                    </tbody>
                  </table>
                  <!-- table-responsive.// -->
                </div>
              </div>
              <!-- card-body end// -->
            </div>
            <!-- card end// -->
            <div class="pagination-area mt-15 mb-50">
                <nav aria-label="Page navigation example">
                    <ul class="pagination  justify-content-center">
      
                        <a class="page-link" href="?page=<%=page+1-1%>"><i class="material-icons md-chevron_left"></i><%page+1+1%></a>
      
                        <li class="page-item ">
                            <a class="page-link" href="?page=<%=page+1%>"><%=page+1%></a>
                        </li>
      
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
      
                        <a class="page-link" href="?page=<%=page+1+1%>"><%page+1+1%><i class="material-icons md-chevron_right"></i></a>
      
                    </ul>
      
                </nav>
            </div>
          </section>
          <!-- content-main end// -->
          <%- include('../partials/adminFooter.ejs') -%>
        </main>
    
        <script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="/assets/js/vendors/select2.min.js"></script>
        <script src="/assets/js/vendors/perfect-scrollbar.js"></script>
        <script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
        <!-- // sweat alert -->
        <script src="/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
        <!-- Main Script -->
        <script src="/assets/js/main.js?v=1.1" type="text/javascript"></script>
      </body>
    </html>
    
    <script>

function previewImage(event) {
    const input = event.target.files[0]
    // let idNumber = input.getAttribute('data-id');
    console.log(input, 'id')


    
   

   
      const reader = new FileReader();

      reader.onload = function (e) {
        console.log(input)


      
        document.getElementById(`imagePreview`).src = e.target.result;
        
        };


      
      reader.readAsDataURL(input);


    
}

function previewImage1(event) {
    const input = event.target.files[0]
    // let idNumber = input.getAttribute('data-id');
    console.log(input, 'id')


    
   

   
      const reader = new FileReader();

      reader.onload = function (e) {
        console.log(input)


      
        document.getElementById(`imagePreview1`).src = e.target.result;
        
        };


      
      reader.readAsDataURL(input);


    
}

    



  






      function listOrUnlist(id) {
        const data = { bannerId: id };
        
        
    
        Swal.fire({
          titleText: "Are you sure",
          width: '400px',
         
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Yes!",
        }).then((decision) => {
          if (decision.isConfirmed) {
            $.ajax({
              method: "put",
              url: "/api/v1/admin/banners/list-unlist-banner",
              data: JSON.stringify(data),
              contentType: "application/json",
              success: (response) => {
                if (response.success === true) {
                
                  $("#Reload").load("/api/v1/admin/banners #Reload", null, () => {
                    Swal.fire({
                      title: `Success`,
                      icon: "success",
                      width: '300px',
                      showConfirmButton: false,
                      timer: 1500
                    });
                  });
                }
              },
            });
          }
        });
      }
    </script>
    <script>
      function editCoupon(id, name, description, url, image) {
        console.log("function is called");
        // console.log(edate);
    
        // let date = new Date(edate)
        // let year = date.getFullYear();
        // let month = String(date.getMonth() + 1).padStart(2, '0');
        // let day = String(date.getDate()).padStart(2, '0');
        // edate = `${year}-${month}-${day}`
        // console.log(`${year}-${month}-${day}`)
    
        document.getElementById("bannerId").value = id;
        document.getElementById("name").value = name;
        document.getElementById("url").value = url;
     
        document.getElementById("description").value = description;
        document.getElementById("imagePreview1").src ="/Data/banners/sharped/"+image
       
        return;
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Add this script after your form -->
    <!-- <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("#exampleModal form");
    
            form.addEventListener("submit", function (event) {
                // Prevent the form from submitting by default
                event.preventDefault();
    
                // Remove previous error messages
                clearErrorMessages();
    
                // Perform validation
                const name = form.elements.name.value.trim();
                const adate = form.elements.adate.value.trim();
                const edate = form.elements.edate.value.trim();
                const limit = form.elements.limit.value.trim();
                const damount = form.elements.damount.value.trim();
    
                if (name === "") {
                    displayErrorMessage("name", "Please enter a coupon name.");
                    return;
                }
    
                if (adate === "") {
                    displayErrorMessage("adate", "Please enter an activation date.");
                    return;
                }
    
                if (edate === "") {
                    displayErrorMessage("edate", "Please enter an expiration date.");
                    return;
                }
    
                if (limit === "") {
                    displayErrorMessage("limit", "Please enter a limit of use.");
                    return;
                }
    
                if (damount === "") {
                    displayErrorMessage("damount", "Please enter a discount amount.");
                    return;
                }
    
                // Validate date format (dd-mm-yyyy)
                const dateRegex = /^\d{2}-\d{2}-\d{4}$/;
                if (!dateRegex.test(adate) ) {
                    displayErrorMessage("adate", "Invalid date format. Please use dd-mm-yyyy.");
                    return;
                } 
                if( !dateRegex.test(edate)) {
                    displayErrorMessage("adate", "Invalid date format. Please use dd-mm-yyyy.");
                    return
                }
    
                // Validate discount amount is a number
                if (isNaN(parseFloat(damount))) {
                    displayErrorMessage("damount", "Discount amount must be a valid number.");
                    return;
                }
    
                // If all validations pass, you can submit the form
                form.submit();
            });
    
            function displayErrorMessage(fieldName, message) {
                const field = form.elements[fieldName];
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.style.color = "red"; // Set color to red
                errorDiv.textContent = message;
                field.parentNode.insertBefore(errorDiv, field);
    
                // Remove error message after 3000 milliseconds (3 seconds)
                setTimeout(() => {
                    errorDiv.remove();
                }, 3000);
            }
    
            function clearErrorMessages() {
                const errorMessages = form.querySelectorAll(".error-message");
                errorMessages.forEach((errorMessage) => {
                    errorMessage.remove();
                });
            }
        });
    </script> -->
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Attach validation to the first form
        attachFormValidation("#exampleModal form");
    
        // Attach validation to the second form
        attachFormValidation("#exampleModal2 form");
    
        function attachFormValidation(formSelector) {
          const form = document.querySelector(formSelector);
    
          form.addEventListener("submit", function (event) {
            // Prevent the form from submitting by default
            event.preventDefault();
    
            // Remove previous error messages
            clearErrorMessages(form);
    
            // Perform validation
            const name = form.elements.name.value.trim();
            const description = form.elements.description.value.trim();
            const url = form.elements.url.value.trim();
            const id = form.elements.id?.value;
            
            
            const image = form.elements.image ?? null
    
           if (!/^(?=.*\S)[a-zA-Z0-9 ]{3,30}$/.test(name)) {
              displayErrorMessage(form, "name", "Please enter a valid coupon name.");
              return;
            }
    
           
    
            if (!/^[a-zA-Zà-žÀ-Ž]{10,}(?:[ '][a-zA-Zà-žÀ-Ž0-9]*)*$/.test(description)) {
              displayErrorMessage(
                form,
                "description",
                "Description must be 10 charectors. and valid"
              );
              return;
            }

            if (url.length <= 3 && !/[^\s/$.?#].[^\s]*$/.test(url)) {
              displayErrorMessage(
                form,
                "url",
                "url must be valid."
              );
              return;
            }
            if(!id) {
                if (image.files.length ==0) {
                     displayErrorMessage(
                    form,
                     "image",
                    "image is required."
                );
                    return;
            }
        }
            
           
    
    
    
           
    
            // Validate discount amount is a number
            
    
            // If all validations pass, you can submit the form
            form.submit();
          });
        }
    
        function displayErrorMessage(form, fieldName, message) {
          const field = form.elements[fieldName];
          const errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          errorDiv.style.color = "red"; // Set color to red
          errorDiv.textContent = message;
          field.parentNode.insertBefore(errorDiv, field);
    
          // Remove error message after 3000 milliseconds (3 seconds)
          setTimeout(() => {
            errorDiv.remove();
          }, 3000);
        }
    
        function clearErrorMessages(form) {
          const errorMessages = form.querySelectorAll(".error-message");
          errorMessages.forEach((errorMessage) => {
            errorMessage.remove();
          });
        }
      });
    </script>
    
       

<script>

    document.addEventListener('DOMContentLoaded', function() { 
        document.querySelectorAll('.product-row').forEach((row) => {
            row.addEventListener('dblclick', (event) => {
                console.log('comes here')
               try {
                 let targetId = event.currentTarget.dataset.target
                 console.log(targetId)
                window.location.href = `/api/v1/admin/products/product-detail?id=${targetId}`
               } catch (error) {
                console.log(error)
                
               }
            })
        })
    })







    function listProduct(id, title, isListed) {
        const data = {
            id: id
        }
        let status = isListed ? 'Unlist' : 'List'

        Swal.fire({

            text: `Do you want to ${status} ${title}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '3085d6',
            cancelButtonColor: 'd33',
            confirmButtonText: 'Yes'

        })
            .then((response) => {
                if (response.isConfirmed) {

                    $.ajax({
                        type: 'put',
                        url: '/api/v1/admin/products/list-product',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: (response) => {
                            if (response.ok) {
                                $('#Reload').load('/api/v1/admin/products #Reload');
                                Swal.fire({
                                    title: `${status}ed!`,
                                    icon: 'success',
                                    text: `Successfully ${status}ed ${title}`,
                                    times: 1500,

                                })
                            }
                        }
                    })



                }
            })


    }



    function Delete(id, title) {
        const data = { id: id }
        Swal.fire({
            title: "Are you sure!",
            text: `Do you want to delete ${title}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '3085d6',
            cancelButtonColor: 'd33',
            confirmButtonText: 'Yes'

        })
            .then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'delete',
                        url: '/api/v1/admin/products/delete-product',
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: (response) => {
                            if (response.ok) {
                                $('#Reload').load('/api/v1/admin/products #Reload', () => {
                                    Swal.fire({
                                        title: 'Deleted!',
                                        icon: 'success',
                                        text: 'Successfully deleted!',
                                        times: 1500,
                                    })
                                })
                            }

                        }



                    })
                }
            })


    }
</script>