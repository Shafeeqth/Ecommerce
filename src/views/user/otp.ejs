<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>OTP Verification</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/assets/css/style.css"> <!-- Assuming you have a main CSS file -->
    <style>
        /* Style for OTP input boxes */
        .otp-input {
            width: 50px;
            /* Adjust width as needed */
            height: 50px;
            /* Adjust height as needed */
            font-size: 24px;
            /* Adjust font size as needed */
            text-align: center;
            margin: 0 5px;
            padding: 0;
            border: 2px solid #ccc;
            border-radius: 5px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .otp-input:focus {
            border-color: #007bff;
            /* Change border color on focus */
        }
    </style>
    <script src="/node_modules/sweetalert2/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="page-wrapper ">
        <header class="header header-6 ">
            <div class="header-top">
                <div class="container">
                    <div class="header-left">
                        <ul class="top-menu top-link-menu d-none d-md-block">
                            <li>
                                <a href="#">Links</a>
                                <ul>
                                    <li><a href="tel:+91 9744491844"><i class="icon-phone"></i>Call: +91 9744491844 </a>
                                    </li>
                                </ul>
                            </li>
                        </ul><!-- End .top-menu -->
                    </div><!-- End .header-left -->

                    <div class="header-right">
                        <div class="social-icons social-icons-color">
                            <a href="#" class="social-icon social-facebook" title="Facebook" target="_blank"><i
                                    class="icon-facebook-f"></i></a>
                            <a href="#" class="social-icon social-twitter" title="Twitter" target="_blank"><i
                                    class="icon-twitter"></i></a>
                            <a href="#" class="social-icon social-instagram" title="Pinterest" target="_blank"><i
                                    class="icon-instagram"></i></a>
                            <a href="#" class="social-icon social-pinterest" title="Instagram" target="_blank"><i
                                    class="icon-pinterest-p"></i></a>
                        </div><!-- End .soial-icons -->
                        <ul class="top-menu top-link-menu">
                            <li>
                                <a href="#">Links</a>

                            </li>
                        </ul><!-- End .top-menu -->
                        <div>About Us.</div>


                    </div><!-- End .header-right -->
                </div>
            </div>
            <div class="header-middle">
                <div class="container">
                    <div class="header-left">
                        <div class="header-search header-search-extended header-search-visible d-none d-lg-block">
                            <a href="" class="search-toggle" role="button"><i class="icon-search"></i></a>
                            <form action="/api/v1/shop" method="get">
                                <div class="header-search-wrapper search-wrapper-wide">
                                    <label for="q" class="sr-only">Search</label>
                                    <button class="btn btn-primary" type="submit"><i class="icon-search"></i></button>
                                    <input type="search" class="form-control" name="q" id="q"
                                        placeholder="Search product ..." required>
                                </div><!-- End .header-search-wrapper -->
                            </form>
                        </div><!-- End .header-search -->
                    </div>
                    <div class="header-center">
                        <a href="index.html" class="logo">
                            <img src="/assets/images/demos/demo-6/logo.png" alt="Molla Logo" width="82" height="20">
                        </a>
                    </div><!-- End .header-left -->
                    <div class="header-right">
                        <i class="la la-lightbulb-o fs-4"></i>
                        <p class="m-3 fs-4">Clearance<span class="highlight fw-bold">&nbsp;Up to 30% Off</span></p>
                    </div>

                </div><!-- End .container -->

            </div><!-- End .header-middle -->


        </header><!-- End .header -->


        <div class="page-wrapper">
            <header class="header">
                <!-- Your header content here -->
            </header>


            <main class="main">
                <div class="login-page bg-image pt-4 pb-4 pt-md-8 pb-md-10 pt-lg-17 pb-lg-17"
                    style="background-image: url('assets/images/backgrounds/login-bg.jpg')">

                    <div class="container w-75 ">

                        <div class="form-box">
                            <h3 class="mb-2 text-center"> Verify your account</h3>
                            <div id="error-div" class="alert text-danger f bg-light rounded text-center d-none  "
                                role="alert"></div>

                            <div id="error" style="display: none;"
                                class="alert text-danger f bg-light rounded text-center  " role="alert"></div>




                            <div class="text-center">
                                <div>
                                    <span>An OTP has been sent to <em class="text-black-50 fs-4">
                                            <%= email %>
                                        </em></span>

                                </div>
                            </div>
                            <div class="form-tab">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="otp-verification" role="tabpanel"
                                        aria-labelledby="otp-verification-tab">

                                        <form id="otp-form" onsubmit="return  validate(event)">
                                            <div class="form-row justify-content-center">
                                                <input required type="text" class="form-control otp-input" maxlength="1"
                                                    data-index="1" name="one" id="one">
                                                <input required type="text" class="form-control otp-input" maxlength="1"
                                                    data-index="2" name="two" id="two">
                                                <input required type="text" class="form-control otp-input" maxlength="1"
                                                    data-index="3" name="three" id="three">
                                                <input required type="text" class="form-control otp-input" maxlength="1"
                                                    data-index="4" name="four" id="four">
                                            </div>
                                            <div class="form-group text-center mt-4">
                                                <button type="submit" class="btn btn-primary" id="verify-btn">Verify
                                                    OTP</button>
                                                <button type="button" onclick="resendOPT()" class="btn btn-link"
                                                    id="resend-btn">Resend OTP</button>
                                                <span id="countdown">1:00</span>
                                            </div>
                                        </form>
                                    </div><!-- End .tab-pane -->
                                </div><!-- End .tab-content -->
                            </div><!-- End .form-tab -->
                        </div><!-- End .form-box -->
                    </div><!-- End .container -->

                </div><!-- End .login-page section-bg -->
            </main><!-- End .main -->

            <footer class="footer">
                <!-- Your footer content here -->
            </footer><!-- End .footer -->
        </div><!-- End .page-wrapper -->

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="/js/otp.js"></script>
        <!-- Bootstrap JS -->
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script>


            function validate(event) {
                event.preventDefault()

                let one = document.getElementById('one');
                let two = document.getElementById('two');
                let three = document.getElementById('three');
                let four = document.getElementById('four');

                if (isNaN(Number(one.value.trim()))) {
                    one.style.border = '1px solid red'
                    setTimeout(() => {
                        one.style.border = ''

                    }, 1500);
                    return false


                } if (isNaN(Number(two.value.trim()))) {
                    two.style.border = '1px solid red'
                    setTimeout(() => {
                        two.style.border = ''

                    }, 1500);
                    return false

                } if (isNaN(Number(three.value.trim()))) {
                    three.style.border = '1px solid red'
                    setTimeout(() => {
                        three.style.border = ''

                    }, 1500);
                    return false

                } if (isNaN(Number(four.value.trim()))) {
                    four.style.border = '1px solid red'
                    setTimeout(() => {
                        four.style.border = ''

                    }, 1500);
                    return false

                }
                let otp = '' + one.value + two.value + three.value + four.value
                console.log(otp)
                fetch('/api/v1/otp-verification', {
                    method: 'post',
                    body: JSON.stringify({ otp }),
                    headers: {

                        'Content-type': 'application/json',
                    },



                }).then(response => response.json())
                    .then((response) => {
                        let errorDiv = document.getElementById('error');
                        if (response.error) {
                            errorDiv.style.display = 'block',
                                errorDiv.innerText = response.message;

                            setTimeout(() => {
                                errorDiv.style.display = 'none';
                                
                            }, 3000);
                        }
                        if (response.success) {
                            Swal.fire({
                                title: "Success",
                                text: response.message,
                                icon: "success",
                                showConfirmButton: false,
                                timer: 1500,

                            });

                            setTimeout(async function askReferrel() {
                                
                                const { value: code } = await Swal.fire({
                                    title: "Do you have a referrel code",
                                    input: "text",
                                    inputLabel: 'Code',
                                    inputPlaceholder: "Your code here",
                                    showCancelButton: true,
                                    cancelButtonText: 'Cancel',
                                    width: '35%',
                                    padding: '15px'


                                });
                                if (code) {
                                    console.log(code)
                                    fetch('/api/v1/referrel-apply', {
                                        method: 'post',
                                        body: JSON.stringify({ code }),
                                        headers: {

                                            'Content-type': 'application/json',
                                        },



                                    }).then(response => response.json())
                                        .then((response) => {
                                            if(response.success) {
                                                Swal.fire({
                                                    title: "Success",
                                                    icon: "success",
                                                    showConfirmButton: false,
                                                    timer: 1000,

                                                        });
                                            setTimeout(() => {
                                                window.location.href = '/api/v1'
                                                
                                            }, 1000);

                                            }else{
                                                Swal.fire({
                                                    title: "Oops!",
                                                    text: response.message,
                                                    icon: "error",
                                                    showConfirmButton: false,
                                                    timer: 1000,

                                                        });
                                                        setTimeout(() => {
                                                            askReferrel()
                                                
                                            }, 1000);

                                            }

                                            
                                        })
                                    
                                }else{
                                    window.location.href = '/api/v1';
                                }
                
                            }, 2000);


                        }
                    })
            }

            function resendOPT() {

                fetch('/api/v1/resend-otp', {
                    headers: {
                        'Accept': 'application/json',
                        'Contend-type': 'application/json',
                    },
                    method: 'PUT',


                }).then(response => response.json())
                    .then((respose) => {

                        let errorDiv = document.getElementById('error-div')
                        if (!respose.success) {
                            errorDiv.style.display = 'block'
                            errorDiv.className = "alert text-danger f bg-light rounded text-center  "
                            errorDiv.innerText = respose.message
                            window.location.href = '/api/v1/signup'
                            setTimeout(() => {
                                errorDiv.style.display = 'none';
                                
                            }, 3000);

                        } else {

                            errorDiv.style.display = 'block'
                            errorDiv.className = "alert text-danger f bg-light rounded text-center  "
                            errorDiv.innerText = "An OTP has been send again!"
                            setTimeout(() => {
                                errorDiv.style.display = 'none';
                                
                            }, 3000);

                        }




                    }).catch((error) => {
                        console.log(error)
                    })



            }


            $(document).ready(function () {
                // Countdown timer for 3 minutes
                var timer = 60;
                var interval = setInterval(function () {
                    timer--;
                    var minutes = Math.floor(timer / 60);
                    var seconds = timer % 60;
                    $("#countdown").text(minutes + ":" + (seconds < 10 ? "0" + seconds : seconds));
                    if (timer === 0) {
                        clearInterval(interval);
                    }
                }, 1000);

                // Focus on the next input when typing in an input box
                $(".otp-input").on("input", function (e) {
                    var maxLength = parseInt($(this).attr("maxlength"));
                    var currentLength = $(this).val().length;
                    var currentIndex = parseInt($(this).data("index"));
                    if (currentLength >= maxLength) {
                        if (currentIndex < 4) {
                            var nextIndex = currentIndex + 1;
                            $('[data-index="' + nextIndex + '"]').focus();
                        }
                    } else {
                        if (currentIndex > 1) {
                            var prevIndex = currentIndex - 1;
                            $('[data-index="' + prevIndex + '"]').focus();
                        }
                    }
                }).on("keydown", function (e) {
                    if (e.which == 8 && $(this).val().length === 0) { // If backspace is pressed and input is empty
                        var currentIndex = parseInt($(this).data("index"));
                        if (currentIndex > 1) {
                            var prevIndex = currentIndex - 1;
                            $('[data-index="' + prevIndex + '"]').focus();
                        }
                    }
                });

                // Resend OTP button click handler
                $("#resend-btn").on("click", function () {
                    // Restart the countdown timer
                    timer = 60;
                    $("#countdown").text("3:00");
                    clearInterval(interval);
                    interval = setInterval(function () {
                        timer--;
                        var minutes = Math.floor(timer / 60);
                        var seconds = timer % 60;
                        $("#countdown").text(minutes + ":" + (seconds < 10 ? "0" + seconds : seconds));
                        if (timer === 0) {
                            clearInterval(interval);
                        }
                    }, 1000);
                });

                // Verify OTP button click handler
                $("#verify-btn").on("click", function () {
                    // Add your OTP verification logic here
                });
            });

        </script>
        <%-include('../partials/userFooter')%>
</body>

</html>